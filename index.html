<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Nachrichten</title>

  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#111; --muted:#6b7280;
      --border:#e5e7eb; --shadow: 0 10px 24px rgba(0,0,0,.08);
      --r:18px;
      --btn:#111; --btnText:#fff;
      --big:22px; --title:28px;
    }
    @media (prefers-color-scheme: dark) {
      :root{ --bg:#0f1115; --card:#161a22; --text:#f2f4f8; --muted:#a9b0c0; --border:#2a3142; --btn:#f2f4f8; --btnText:#0f1115; }
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
    }

    .app{
      height:100%;
      max-width:1100px;
      margin:0 auto;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .hleft{ display:flex; flex-direction:column; gap:2px; }
    .hleft .t{ font-size:var(--title); font-weight:800; letter-spacing:.2px; }
    .hleft .s{ color:var(--muted); font-size:14px; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:none;
      background:var(--btn);
      color:var(--btnText);
      padding:12px 14px;
      border-radius:999px;
      font-size:16px;
      font-weight:800;
    }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      font-weight:800;
    }
    .btn:active{ transform:scale(.98); }

    main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      main{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      min-height:0;
      box-sizing:border-box;
    }

    .sources{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .source{
      width:100%;
      text-align:left;
      background:transparent;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      font-size:22px;
      font-weight:900;
      color:var(--text);
    }
    .source small{
      display:block;
      margin-top:4px;
      color:var(--muted);
      font-size:14px;
      font-weight:600;
    }
    .source.active{
      outline:3px solid rgba(90,140,255,.35);
      border-color: rgba(90,140,255,.55);
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .topline{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .where{
      font-size:20px;
      font-weight:900;
    }
    .hint{
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    /* Standard: Liste + Leser nebeneinander */
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height:0;
      flex:1;
    }
    @media (max-width: 1000px){
      .split{ grid-template-columns: 1fr; }
    }

    .list, .reader{
      border:1px solid var(--border);
      border-radius:16px;
      background:transparent;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      min-height:0;
    }

    .listItem{
      padding:14px 14px;
      border-bottom:1px solid var(--border);
    }
    .listItem:last-child{ border-bottom:none; }
    .listItem button{
      width:100%;
      text-align:left;
      background:transparent;
      border:none;
      color:var(--text);
      padding:0;
      font-size:var(--big);
      font-weight:900;
    }
    .listItem .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      font-weight:600;
    }

    .loading{
      padding:14px;
      color:var(--muted);
      font-weight:800;
      font-size:16px;
    }
    .error{
      padding:14px;
      color:var(--text);
      font-weight:900;
      font-size:16px;
    }
    .smallNote{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      font-weight:700;
    }

    /* Leser */
    .readerInner{
      padding:16px 16px 24px;
      line-height:1.55;
    }
    .readerInner h2{
      margin:0 0 10px 0;
      font-size:26px;
      font-weight:900;
      letter-spacing:.2px;
      -webkit-user-select:text;
      user-select:text;
    }
    .readerInner .by{
      color:var(--muted);
      font-size:14px;
      font-weight:800;
      margin-bottom:12px;
      -webkit-user-select:text;
      user-select:text;
    }
    .readerInner p{
      margin: 0 0 12px 0;
      font-size:20px;
      font-weight:650;
      -webkit-user-select:text;
      user-select:text;
    }
    .hero{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      margin: 8px 0 12px;
      display:none;
    }
    .readerActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 2px;
    }

    /* Lesemodus: Quellen + Liste ausblenden, Leser nimmt alles */
    .readingMode main{ grid-template-columns: 1fr; }
    .readingMode #sourcesCard{ display:none; }
    .readingMode #listWrap{ display:none; }
    .readingMode .split{ grid-template-columns: 1fr; }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <header>
      <div class="hleft">
        <div class="t">Nachrichten</div>
        <div class="s">Alles bleibt an einem Ort. Große Schrift. Mit Zurück, Home und Lesemodus.</div>
      </div>
      <div class="controls">
        <button class="btn secondary" id="backBtn">Zurück</button>
        <button class="btn secondary" id="homeBtn">Home</button>
        <button class="btn secondary" id="toggleReadBtn">Lesemodus</button>
        <button class="btn secondary" id="aMinus">A−</button>
        <button class="btn secondary" id="aPlus">A+</button>
        <button class="btn" id="refreshBtn">Aktualisieren</button>
      </div>
    </header>

    <main>
      <section class="card sources" id="sourcesCard">
        <div id="sources"></div>
      </section>

      <section class="card content">
        <div class="topline">
          <div class="where" id="where">Bitte links eine Zeitung wählen</div>
          <div class="hint" id="hint">Dann erscheinen rechts die Überschriften. Antippen = Artikel lesen.</div>
        </div>

        <div class="split">
          <div class="list" id="listWrap">
            <div id="list"><div class="loading">Wähle eine Zeitung links.</div></div>
          </div>

          <div class="reader" id="reader">
            <div class="loading">Hier erscheint der Artikel.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
  // Markieren/Contextmenu möglichst vermeiden
  document.addEventListener('selectstart', e => e.preventDefault());
  document.addEventListener('contextmenu', e => e.preventDefault());

  const appRoot = document.getElementById('appRoot');

  // Proxy: CORS-Probleme sind der Hauptgrund für "RSS kann nicht geladen werden"
  const AO_RAW = (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

  // Google News RSS als zuverlässiger Fallback
  function googleNewsRss(query, countryCode, lang){
    const ceid = `${countryCode}:${lang}`;
    const q = encodeURIComponent(query);
    return `https://news.google.com/rss/search?q=${q}&hl=${lang}&gl=${countryCode}&ceid=${ceid}`;
  }

  // Quellen: Original-RSS + Fallback
  const SOURCES = [
    {
      name:"ORF",
      desc:"Österreich",
      feeds:[
        "https://rss.orf.at/news.xml",
        googleNewsRss("site:orf.at ORF", "AT", "de")
      ]
    },
    {
      name:"ZDF heute",
      desc:"Deutschland",
      feeds:[
        "https://www.zdf.de/rss/zdf/nachrichten",
        googleNewsRss("site:zdf.de heute nachrichten", "DE", "de")
      ]
    },
    {
      name:"Kurier",
      desc:"Österreich",
      feeds:[
        "https://kurier.at/rss",
        googleNewsRss("site:kurier.at kurier", "AT", "de")
      ]
    },
    {
      name:"Die Presse",
      desc:"Österreich",
      feeds:[
        "https://www.diepresse.com/rss",
        googleNewsRss("site:diepresse.com die presse", "AT", "de")
      ]
    },
    {
      name:"tagesschau",
      desc:"Deutschland",
      feeds:[
        "https://www.tagesschau.de/xml/rss2/",
        googleNewsRss("site:tagesschau.de tagesschau", "DE", "de")
      ]
    },
    {
      name:"BBC World",
      desc:"International",
      feeds:[
        "https://feeds.bbci.co.uk/news/world/rss.xml",
        "https://feeds.bbci.co.uk/news/rss.xml"
      ]
    }
  ];

  const elSources = document.getElementById('sources');
  const elList = document.getElementById('list');
  const elReader = document.getElementById('reader');
  const elWhere = document.getElementById('where');
  const elHint = document.getElementById('hint');

  const backBtn = document.getElementById('backBtn');
  const homeBtn = document.getElementById('homeBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const toggleReadBtn = document.getElementById('toggleReadBtn');
  const aPlus = document.getElementById('aPlus');
  const aMinus = document.getElementById('aMinus');

  let currentSourceIndex = -1;
  let currentItems = [];
  let navStack = []; // {type:'list', sourceIndex} oder {type:'article', item, viewMode}
  let readingMode = false;

  // Schriftgröße
  let big = 22;
  function applySize(){ document.documentElement.style.setProperty('--big', big + 'px'); }
  aPlus.addEventListener('click', () => { big = Math.min(36, big + 2); applySize(); });
  aMinus.addEventListener('click', () => { big = Math.max(18, big - 2); applySize(); });
  applySize();

  toggleReadBtn.addEventListener('click', () => {
    readingMode = !readingMode;
    appRoot.classList.toggle('readingMode', readingMode);
    toggleReadBtn.textContent = readingMode ? "Liste anzeigen" : "Lesemodus";
  });

  function setActiveSource(index){
    [...elSources.querySelectorAll('.source')].forEach((b,i)=>{
      b.classList.toggle('active', i===index);
    });
  }

  function esc(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function fetchText(url){
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error("Netzwerkfehler");
    return await r.text();
  }

  function stripToXml(text){
    const start = text.indexOf("<");
    return start >= 0 ? text.slice(start) : text;
  }

  function parseRss(xmlText){
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "text/xml");

    let items = [...xml.querySelectorAll("item")].map(it => ({
      title: (it.querySelector("title")?.textContent || "").trim(),
      link: (it.querySelector("link")?.textContent || "").trim(),
      date: (it.querySelector("pubDate")?.textContent || "").trim(),
      desc: (it.querySelector("description")?.textContent || "").trim()
    }));

    if(items.length === 0){
      items = [...xml.querySelectorAll("entry")].map(en => ({
        title: (en.querySelector("title")?.textContent || "").trim(),
        link: (en.querySelector("link")?.getAttribute("href") || "").trim(),
        date: (en.querySelector("updated")?.textContent || en.querySelector("published")?.textContent || "").trim(),
        desc: (en.querySelector("summary")?.textContent || "").trim()
      }));
    }

    return items.filter(x => x.title && x.link).slice(0, 60);
  }

  async function fetchRssWithFallback(feeds){
    let lastErr = null;
    for(const f of feeds){
      try{
        const t = await fetchText(AO_RAW(f));
        const xmlText = stripToXml(t);
        const items = parseRss(xmlText);
        if(items.length) return { items, usedFeed: f };
        lastErr = new Error("Keine Überschriften gefunden");
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("RSS konnte nicht geladen werden.");
  }

  // Sehr robuster Artikel-Reader:
  // Wir laden die Original-HTML über allorigins (CORS-safe),
  // nehmen Title, og:image, Datum (falls vorhanden) und Absätze.
  async function fetchArticleRobust(url){
    const raw = await fetchText(AO_RAW(url));
    const html = stripToXml(raw);

    const doc = new DOMParser().parseFromString(html, "text/html");
    doc.querySelectorAll("script,style,noscript").forEach(n => n.remove());

    const title =
      (doc.querySelector("meta[property='og:title']")?.content || doc.title || "Artikel").trim();

    const site =
      (doc.querySelector("meta[property='og:site_name']")?.content ||
       doc.querySelector("meta[name='application-name']")?.content ||
       "").trim();

    const ogImg =
      (doc.querySelector("meta[property='og:image']")?.content ||
       doc.querySelector("meta[name='twitter:image']")?.content ||
       "").trim();

    // Datum-Fallbacks (oft nicht vorhanden)
    const date =
      (doc.querySelector("meta[property='article:published_time']")?.content ||
       doc.querySelector("time")?.getAttribute("datetime") ||
       "").trim();

    const container = doc.querySelector("article") || doc.querySelector("main") || doc.body;

    // Absätze sammeln
    let ps = [...container.querySelectorAll("p")]
      .map(p => p.textContent.replace(/\s+/g," ").trim())
      .filter(t => t.length >= 60);

    // Fallback: Text aus dem Container in Blöcke schneiden
    if(ps.length < 4){
      const rawText = (container.textContent || "").replace(/\s+/g," ").trim();
      ps = rawText
        .split(/(?<=[.!?])\s+/)
        .reduce((acc, s) => {
          if(!acc.length || (acc[acc.length-1].length + s.length) > 320) acc.push(s);
          else acc[acc.length-1] += " " + s;
          return acc;
        }, [])
        .filter(t => t.length >= 120)
        .slice(0, 24);
    } else {
      ps = ps.slice(0, 18);
    }

    return { title, site, ogImg, date, paragraphs: ps, url };
  }

  function renderSources(){
    elSources.innerHTML = "";
    SOURCES.forEach((s, idx) => {
      const b = document.createElement('button');
      b.className = 'source';
      b.innerHTML = `${s.name}<small>${s.desc}</small>`;
      b.addEventListener('click', () => selectSource(idx));
      elSources.appendChild(b);
    });
  }

  function renderList(items, usedFeed){
    elList.innerHTML = "";
    if(items.length === 0){
      elList.innerHTML = `<div class="error">Keine Überschriften gefunden.</div>`;
      return;
    }

    const note = document.createElement('div');
    note.className = "smallNote";
    note.style.padding = "12px 14px 0";
    note.textContent = usedFeed.includes("news.google.com") ? "Quelle: Google News (stabil)" : "Quelle: Original-RSS";
    elList.appendChild(note);

    items.forEach((it) => {
      const div = document.createElement('div');
      div.className = "listItem";

      const btn = document.createElement('button');
      btn.textContent = it.title;

      btn.addEventListener('click', () => openArticle(it));

      const meta = document.createElement('div');
      meta.className = "meta";
      meta.textContent = it.date ? it.date : "";

      div.appendChild(btn);
      div.appendChild(meta);
      elList.appendChild(div);
    });
  }

  function renderReaderLoading(msg){
    elReader.innerHTML = `<div class="loading">${esc(msg)}</div>`;
  }

  function renderReaderArticle(a){
    elReader.innerHTML = `
      <div class="readerInner">
        <h2>${esc(a.title)}</h2>
        <div class="by">${esc(a.site)}${a.date ? " • " + esc(a.date) : ""}</div>
        <img class="hero" id="heroImg" alt="Bild" />
        <div class="readerActions">
          <button class="btn secondary" id="btnReadMode">Lesemodus</button>
          <button class="btn secondary" id="btnShowList">Liste</button>
          <button class="btn secondary" id="btnOriginal">Original (innerhalb der App)</button>
        </div>
        ${a.paragraphs.length
          ? a.paragraphs.map(p => `<p>${esc(p)}</p>`).join("")
          : `<p>Dieser Artikel ist leider schwer auszulesen (Paywall oder spezielles Layout).</p>`
        }
        <div class="smallNote">Tipp: Lesemodus = mehr Platz zum Lesen.</div>
      </div>
    `;

    // Bild nur anzeigen, wenn es lädt
    const hero = document.getElementById('heroImg');
    if(a.ogImg){
      hero.src = a.ogImg;
      hero.onload = () => { hero.style.display = "block"; };
      hero.onerror = () => { hero.style.display = "none"; };
    }

    document.getElementById('btnReadMode').addEventListener('click', () => {
      readingMode = true;
      appRoot.classList.add('readingMode');
      toggleReadBtn.textContent = "Liste anzeigen";
    });

    document.getElementById('btnShowList').addEventListener('click', () => {
      readingMode = false;
      appRoot.classList.remove('readingMode');
      toggleReadBtn.textContent = "Lesemodus";
    });

    // "Original" innerhalb der App: Wir zeigen eine sehr simple Original-Ansicht
    // (nicht neues Tab, nicht Safari-Back nötig)
    document.getElementById('btnOriginal').addEventListener('click', () => {
      openOriginalInApp(a.url, a.title);
    });
  }

  async function openOriginalInApp(url, title){
    // Diese Ansicht ist “Original in der App”: Wir laden die Seite als Text,
    // damit es nicht kaputt geht durch Frames/Sperren.
    renderReaderLoading("Original wird geladen…");

    try{
      const raw = await fetchText(AO_RAW(url));
      const html = stripToXml(raw);
      const doc = new DOMParser().parseFromString(html, "text/html");
      doc.querySelectorAll("script,style,noscript").forEach(n => n.remove());

      // Etwas mehr Text holen als beim Reader
      const container = doc.querySelector("article") || doc.querySelector("main") || doc.body;
      const rawText = (container.textContent || "").replace(/\s+/g," ").trim();

      const chunks = rawText
        .split(/(?<=[.!?])\s+/)
        .reduce((acc, s) => {
          if(!acc.length || (acc[acc.length-1].length + s.length) > 360) acc.push(s);
          else acc[acc.length-1] += " " + s;
          return acc;
        }, [])
        .filter(t => t.length >= 140)
        .slice(0, 40);

      elReader.innerHTML = `
        <div class="readerInner">
          <h2>${esc(title || "Original")}</h2>
          <div class="by">Original (Text-Ansicht) • Bleibt in der App</div>
          <div class="readerActions">
            <button class="btn secondary" id="btnBackToArticle">Zurück zum Artikel</button>
            <button class="btn secondary" id="btnReadMode2">Lesemodus</button>
            <button class="btn secondary" id="btnShowList2">Liste</button>
          </div>
          ${chunks.length ? chunks.map(p => `<p>${esc(p)}</p>`).join("") : `<p>Dieser Artikel ist leider schwer auszulesen.</p>`}
          <div class="smallNote">Wenn etwas fehlt: Manche Seiten geben den Inhalt ohne Abo nicht vollständig frei.</div>
        </div>
      `;

      document.getElementById('btnBackToArticle').addEventListener('click', () => {
        // Einfach nochmal die letzte Article-Ansicht rendern (aus Stack)
        const top = navStack[navStack.length - 1];
        if(top?.type === 'article' && top.cachedArticle){
          renderReaderArticle(top.cachedArticle);
        }else{
          renderReaderLoading("Zurück…");
        }
      });

      document.getElementById('btnReadMode2').addEventListener('click', () => {
        readingMode = true;
        appRoot.classList.add('readingMode');
        toggleReadBtn.textContent = "Liste anzeigen";
      });

      document.getElementById('btnShowList2').addEventListener('click', () => {
        readingMode = false;
        appRoot.classList.remove('readingMode');
        toggleReadBtn.textContent = "Lesemodus";
      });

    }catch(e){
      elReader.innerHTML = `<div class="error">Original konnte nicht geladen werden.</div>`;
    }
  }

  async function selectSource(index){
    currentSourceIndex = index;
    setActiveSource(index);

    const src = SOURCES[index];
    elWhere.textContent = src.name + " – Überschriften";
    elHint.textContent = "Tippe eine Überschrift an. Im Leser kannst du Lesemodus aktivieren.";

    navStack = [{ type:'list', sourceIndex:index }];

    elList.innerHTML = `<div class="loading">Lade Überschriften…</div>`;
    renderReaderLoading("Hier erscheint der Artikel.");

    try{
      const { items, usedFeed } = await fetchRssWithFallback(src.feeds);
      currentItems = items;
      renderList(currentItems, usedFeed);
    }catch(e){
      elList.innerHTML = `
        <div class="error">
          Fehler: RSS konnte nicht geladen werden.
          <div class="smallNote">Wichtig: Datei in Safari öffnen (nicht nur Vorschau in „Dateien“).</div>
        </div>`;
    }
  }

  async function openArticle(item){
    // Wir ändern NICHT die Überschriftenliste, damit dort nichts “kaputt” wird.
    // Nur rechts laden wir den Artikel.
    navStack.push({ type:'article', item, cachedArticle:null });

    renderReaderLoading("Lade Artikel…");

    try{
      const art = await fetchArticleRobust(item.link);
      // Cache im Stack, damit „Original“ und Zurück stabil bleiben
      navStack[navStack.length - 1].cachedArticle = art;

      renderReaderArticle(art);
      const src = currentSourceIndex >= 0 ? SOURCES[currentSourceIndex] : null;
      elWhere.textContent = (src ? src.name : "Nachrichten") + " – Artikel";
    }catch(e){
      elReader.innerHTML = `
        <div class="error">
          Artikel konnte nicht geladen werden.
          <div class="smallNote">Manche Seiten blockieren Inhalte ohne Abo oder haben Spezial-Layouts.</div>
        </div>`;
    }
  }

  function goBack(){
    if(navStack.length <= 1) return;
    navStack.pop();

    const top = navStack[navStack.length-1];
    if(top.type === 'list'){
      const src = SOURCES[top.sourceIndex];
      elWhere.textContent = src.name + " – Überschriften";
      elHint.textContent = "Tippe eine Überschrift an. Im Leser kannst du Lesemodus aktivieren.";
      renderReaderLoading("Hier erscheint der Artikel.");
    } else if(top.type === 'article'){
      if(top.cachedArticle) renderReaderArticle(top.cachedArticle);
      else openArticle(top.item);
    }
  }

  function goHome(){
    navStack = [];
    currentItems = [];
    currentSourceIndex = -1;

    setActiveSource(-1);
    elWhere.textContent = "Bitte links eine Zeitung wählen";
    elHint.textContent = "Dann erscheinen rechts die Überschriften. Antippen = Artikel lesen.";

    elList.innerHTML = `<div class="loading">Wähle eine Zeitung links.</div>`;
    renderReaderLoading("Hier erscheint der Artikel.");

    // optional: Lesemodus beenden
    readingMode = false;
    appRoot.classList.remove('readingMode');
    toggleReadBtn.textContent = "Lesemodus";
  }

  backBtn.addEventListener('click', goBack);
  homeBtn.addEventListener('click', goHome);
  refreshBtn.addEventListener('click', () => {
    if(currentSourceIndex >= 0) selectSource(currentSourceIndex);
  });

  // Start
  renderSources();
  goHome();
</script>
</body>
</html>
